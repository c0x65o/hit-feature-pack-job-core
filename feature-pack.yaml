# Feature Pack: job-core
# Core job management UI (execution history + scheduling)

name: job-core
title: System Jobs
description: "Core job management UI: execution history, schedules, and admin tools"

derived_services:
  - name: job
    description: Job execution worker
    run_mode: jobs
    command: node .hit/generated/hit_tasks_worker.cjs
    base_services_from: tasks
    requires_tasks: true
    options_key: worker
    env:
      HIT_TASKS_BASE_SERVICE: "{{base_service}}"
      HIT_APP_URL: "{{base_service_url}}"
    env_from_manifest:
      HIT_TASKS_CRON_TZ: reporting.timezone
    required_files:
      - .hit/generated/hit_tasks_worker.cjs
      - .hit/generated/hit_tasks_manifest.json

# Route definitions - mapped to React components
routes:
  - path: /admin/jobs
    page: TaskList
    roles: []
    default_roles_allow: [admin]
    authz: { entity: list, verb: read, require_mode: any }
  - path: /admin/jobs/executions
    page: AllExecutions
    roles: []
    default_roles_allow: [admin]
    authz: { entity: results, verb: read, require_mode: any }
  - path: /admin/jobs/[name]
    page: TaskDetail
    roles: []
    default_roles_allow: [admin]
    authz: { entity: list, verb: read, require_mode: any }
  - path: /admin/jobs/[name]/executions/[id]
    page: TaskExecution
    roles: []
    default_roles_allow: [admin]
    authz: { entity: results, verb: read, require_mode: any }

# Navigation contributions - auto-added to shell sidebar
nav:
  - id: jobs
    label: Jobs
    icon: CirclePlay
    group: system
    roles: [admin]
    showWhen: authenticated
    weight: 900
    children:
      - id: jobs-list
        label: List
        path: /admin/jobs
        icon: ListChecks
        weight: 100
        roles: [admin]
        showWhen: authenticated
      - id: jobs-executions
        label: Results
        path: /admin/jobs/executions
        icon: History
        weight: 110
        roles: [admin]
        showWhen: authenticated

# ─────────────────────────────────────────────────────────────────────────────
# PERMISSIONS - Action definitions (for admin-core permissions UI + runtime checks)
# ─────────────────────────────────────────────────────────────────────────────
permissions:
  actions:
    # Scope Policy Tree: job-core (global) -> entity overrides.
    #
    # Scope modes:
    # - none: deny all access for this verb/entity (hide pages + block APIs)
    # - all: ignore scope (read everything)
    # - own: only owned records (not applicable for list/results - they don't have ownership fields)
    # - ldd: owner OR matching L/D/D (not applicable for list/results - they don't have LDD fields)
    #
    # These are mutually exclusive per node; the Security Groups UI renders them as dropdowns.
    # Note: List and results are system-level entities without ownership or LDD fields,
    # so `own` and `ldd` modes deny access (only `all` mode allows access).
    - key: job-core.read.scope.none
      label: "Job Core Read Scope = None"
      description: "Deny all job core read access."
      default_enabled: false
    - key: job-core.read.scope.all
      label: "Job Core Read Scope = All"
      description: "Read all job core entities regardless of scope."
      default_enabled: false
    - key: job-core.read.scope.own
      label: "Job Core Read Scope = Own"
      description: "Read only job core entities you own (not applicable for tasks/executions - they don't have ownership fields)."
      default_enabled: false

    - key: job-core.write.scope.none
      label: "Job Core Write Scope = None"
      description: "Deny all job core write access."
      default_enabled: false
    - key: job-core.write.scope.all
      label: "Job Core Write Scope = All"
      description: "Edit job core entities regardless of scope."
      default_enabled: false
    - key: job-core.write.scope.own
      label: "Job Core Write Scope = Own"
      description: "Edit only job core entities you own (not applicable for tasks/executions - they don't have ownership fields)."
      default_enabled: false

    # List override (optional): if set, overrides job-core.read.scope.* for list only.
    - key: job-core.list.read.scope.none
      label: "Job Core List Read Scope = None"
      description: "Deny all list read access."
      default_enabled: false
    - key: job-core.list.read.scope.all
      label: "Job Core List Read Scope = All"
      description: "Read list regardless of scope."
      default_enabled: false
    - key: job-core.list.read.scope.own
      label: "Job Core List Read Scope = Own"
      description: "Read only list you own (not applicable - list don't have ownership fields)."
      default_enabled: false

    - key: job-core.list.write.scope.none
      label: "Job Core List Write Scope = None"
      description: "Deny all list write access."
      default_enabled: false
    - key: job-core.list.write.scope.all
      label: "Job Core List Write Scope = All"
      description: "Edit list regardless of scope."
      default_enabled: false
    - key: job-core.list.write.scope.own
      label: "Job Core List Write Scope = Own"
      description: "Edit only list you own (not applicable - list don't have ownership fields)."
      default_enabled: false

    # Results override (optional): if set, overrides job-core.read.scope.* for results only.
    - key: job-core.results.read.scope.none
      label: "Job Core Results Read Scope = None"
      description: "Deny all results read access."
      default_enabled: false
    - key: job-core.results.read.scope.all
      label: "Job Core Results Read Scope = All"
      description: "Read results regardless of scope."
      default_enabled: false
    - key: job-core.results.read.scope.own
      label: "Job Core Results Read Scope = Own"
      description: "Read only results you own (not applicable - results don't have ownership fields)."
      default_enabled: false

    - key: job-core.results.write.scope.none
      label: "Job Core Results Write Scope = None"
      description: "Deny all results write access."
      default_enabled: false
    - key: job-core.results.write.scope.all
      label: "Job Core Results Write Scope = All"
      description: "Edit results regardless of scope."
      default_enabled: false
    - key: job-core.results.write.scope.own
      label: "Job Core Results Write Scope = Own"
      description: "Edit only results you own (not applicable - results don't have ownership fields)."
      default_enabled: false

    - key: job-core.list.execute
      label: Execute Task
      description: "Execute a task manually (triggers task execution)."
      default_enabled: false

# Dependencies
requires:
  modules: [tasks]

